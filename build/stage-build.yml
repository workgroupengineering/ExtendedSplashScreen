parameters:
  DotNetVersion: '7.0.102'
  UnoCheck_Version: '1.11.0'
  UnoCheck_Manifest: 'https://raw.githubusercontent.com/unoplatform/uno.check/146b0b4b23d866bef455494a12ad7ffd2f6f2d20/manifests/uno.ui.manifest.json'

steps:
- task: gitversion/setup@0
  inputs:
    versionSpec: '5.10.1'
  displayName: 'Install GitVersion'

- task: gitversion/execute@0
  inputs:
    useConfigFile: true
    configFilePath: $(Build.SourcesDirectory)/build/gitversion.yml
  displayName: 'Calculate version'

- task: NuGetToolInstaller@1
  displayName: 'Install NuGet $(NUGET_VERSION)'
  inputs:
    versionSpec: $(NUGET_VERSION)
    checkLatest: false

- task: VisualStudioTestPlatformInstaller@1
  condition: and(succeeded(), eq(variables['ApplicationPlatform'], 'NuGet'))
  inputs:
    packageFeedSelector: 'nugetOrg'
    versionSelector: 'specificVersion'
    testPlatformVersion: $(VSTEST_PLATFORM_VERSION)

- task: UseDotNet@2
  displayName: 'Use .NET SDK ${{ parameters.DotNetVersion }}'
  retryCountOnTaskFailure: 3
  inputs:
    packageType: sdk
    version: ${{ parameters.DotNetVersion }}
    includePreviewVersions: true

- powershell: |
    & dotnet tool update --global uno.check --version ${{ parameters.UnoCheck_Version }} --add-source https://api.nuget.org/v3/index.json
    & uno-check -v --ci --non-interactive --fix --skip xcode --skip gtk3 --skip vswin --skip vsmac --skip androidsdk --skip androidemulator --manifest ${{ parameters.UnoCheck_Manifest }}
  displayName: Install .NET Workloads | Uno-check
  errorActionPreference: continue
  ignoreLASTEXITCODE: true
  retryCountOnTaskFailure: 3

- task: MSBuild@1
  displayName: 'Restore solution packages'
  inputs:
    solution: $(Build.SourcesDirectory)/$(SolutionFileName)
    msbuildLocationMethod: version
    msbuildVersion: latest
    msbuildArchitecture: x86
    msbuildArguments: >
      /t:restore
    configuration: $(ApplicationConfiguration)
    platform: $(ApplicationPlatform)
    clean: false
    maximumCpuCount: true
    restoreNugetPackages: false
    logProjectEvents: false
    createLogFile: false

- task: MSBuild@1
  displayName: 'Build solution in $(ApplicationConfiguration) | $(ApplicationPlatform)'
  inputs:
    solution: $(Build.SourcesDirectory)/$(SolutionFileName)
    msbuildLocationMethod: version
    msbuildVersion: latest
    msbuildArchitecture: x86
    configuration: $(ApplicationConfiguration)
    platform: $(ApplicationPlatform)
    clean: false
    maximumCpuCount: true
    restoreNugetPackages: false
    logProjectEvents: false
    createLogFile: false
    msbuildArguments: > # Set the version of the packages, will have no effect on application projects (Heads).
      /p:PackageVersion=$(GitVersion.SemVer) 
      /bl:$(build.artifactstagingdirectory)/build.binlog

- task: VSTest@2
  displayName: 'Run tests'
  condition: and(succeeded(), eq(variables['ApplicationPlatform'], 'NuGet'))
  inputs:
    testAssemblyVer2: |
      **\*tests*.dll
      !**\obj\**
    vstestLocationMethod: version
    vsTestVersion: "latest"
    testSelector: testAssemblies

- task: PublishBuildArtifacts@1
  displayName: 'Publish artifact $(ApplicationConfiguration)'
  inputs:
    PathtoPublish: $(PackageOutputPath)
    ArtifactName: $(ArtifactName)
    ArtifactType: Container

- task: PostBuildCleanup@3
  displayName: 'Post-Build cleanup :  Cleanup files to keep build server clean!'
  condition: always()